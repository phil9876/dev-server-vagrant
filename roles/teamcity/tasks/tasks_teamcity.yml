---

  - name: Create teamcity group
    group: name=teamcity gid=517

  - name: Teamcity | create application user
    user: name=teamcity comment="Teamcity CI" uid=517 group=teamcity
    become: yes
    tags:
      - teamcity

  - name: Teamcity | Check if present
    command: test -x {{teamcity_install_dir}}/TeamCity/bin/catalina.sh
    register: teamcity_present
    ignore_errors: yes
    tags:
      - teamcity

  - name: Teamcity |  Create installation directories
    file: path="{{item}}" state=directory owner=teamcity group=teamcity
    become: yes
    with_items:
      - "{{teamcity_install_dir}}"
      - "{{teamcity_install_dir}}/.BuildServer/lib/jdbc"
      - "{{teamcity_install_dir}}/.BuildServer/config"
    tags:
      - teamcity

  - name: Teamcity |  Get distribution
    get_url: url="https://download.jetbrains.com/teamcity/TeamCity-{{teamcity_version}}.tar.gz" dest="/tmp/TeamCity-{{teamcity_version}}.tar.gz" validate_certs=no
    become: yes
    become_user: teamcity
    when: teamcity_present | failed
    tags:
      - teamcity

  - name: Teamcity |  Unpack distribution
    unarchive: src="/tmp/TeamCity-{{teamcity_version}}.tar.gz" dest="{{teamcity_install_dir}}" copy="no"
    become: yes
    when: teamcity_present | failed
    tags:
      - teamcity

  - name: Create logs folder for agent
    file: path={{teamcity_install_dir}}/TeamCity/buildAgent/logs state=directory owner=teamcity group=teamcity

  - name: Change owner and group of teamcity installation
    file: path={{teamcity_install_dir}} owner=teamcity group=teamcity recurse=yes

  - name: Teamcity |  Get postgress jdbc driver
    get_url: url="http://jdbc.postgresql.org/download/postgresql-9.3-1101.jdbc41.jar" dest="{{teamcity_install_dir}}/.BuildServer/lib/jdbc/postgresql-9.3-1101.jdbc41.jar"
    become: yes
    become_user: teamcity
    when: teamcity_present | failed
    tags:
      - teamcity

  - name: Teamcity |  Template database connection config
    template: src="{{role_dir}}/templates/postgres/postgres.database.properties.j2" dest="{{teamcity_install_dir}}/.BuildServer/config/database.properties"
    become: yes
    become_user: teamcity
    tags:
      - teamcity

  - name: Teamcity |  Template upstart
    template: src="{{role_dir}}/templates/upstart/teamcity.j2" dest="/etc/init.d/teamcity" mode="755"
    become: yes

    tags:
      - teamcity

  - name: Teamcity |  Template nginx conf
    template: src="{{role_dir}}/templates/nginx/teamcity.conf.j2" dest="/etc/nginx/sites-enabled/{{teamcity_domain}}"
    become: yes
    tags:
      - teamcity

  - name: Install chkconfig
    apt: name=chkconfig

  - name: Install .service file
    template: src="{{role_dir}}/templates/systemd/{{ item }}.j2" dest="/etc/systemd/system/{{ item }}"
    become: yes
    with_items:
      - teamcity.service
      - teamcity-agent.service

  - name: Set Teamcity to start automatically
    shell: chkconfig --level 2345 teamcity on
    notify: Start teamcity

  - name: Enable services
    shell: systemctl enable {{ item }}.service
    with_items:
      - teamcity
      - teamcity-agent
    notify: Start teamcity